---
- name: '{{ item }} firewall operation'
  block:
    - name: Allow node exporter service port
      lineinfile:
        dest: '/etc/sysconfig/iptables'
        regexp: '^-A INPUT -p tcp -m tcp --dport {{ vars[item + "_port"] }} -j ACCEPT$'
        line: '-A INPUT -p tcp -m tcp --dport {{ vars[item + "_port"] }} -j ACCEPT'
        insertafter: '^:OUTPUT ACCEPT \[\d*:\d*\]$'
    - name: Reload the node exporter service firewalld
      service:
        name: 'iptables'
        state: 'reloaded'
  loop: '{{ os_linux_exporter_type | lower }}'
  when: 
    - ansible_distribution_major_version|int == 6

- name: Gathering service facts
  service_facts:
  register: services_state

- name: '{{ item }} firewall operation'
  firewalld:
    port: '{{ vars[item + "_port"] }}/tcp'
    zone: 'public'
    permanent: 'true'
    immediate: 'true'
    state: 'enabled'
  loop: '{{ os_linux_exporter_type | lower }}'
  when: 
    - ansible_distribution_major_version|int > 6
    - services_state.ansible_facts.services["firewalld.service"] is defined
    - services_state.ansible_facts.services["firewalld.service"].state == 'running'
