---
- name: Configure runtime kernel parameters
  sysctl:
    name: '{{ item.variable }}'
    value: '{{ item.value }}'
    state: present
    reload: yes
    sysctl_set: yes
    sysctl_file: '/etc/sysctl.d/10-sysctl.conf'
  loop: '{{ os_linux_kernel_parameters }}'
  changed_when: false
  failed_when: false

- name: Set nofile limits
  lineinfile:
    dest: /etc/security/limits.conf
    state: present
    line: '{{ item }}'
  with_items:
    - '* soft nofile {{ os_linux_ulimit_nofile }}'
    - '* hard nofile {{ os_linux_ulimit_nofile }}'

- name: Set nproc limits
  lineinfile: 
    dest: /etc/security/limits.d/90-nproc.conf
    insertafter: EOF
    state: present
    create: yes
    mode: 0644
    line: '{{ item }}'
  with_items:
    - '* soft nproc {{ os_linux_ulimit_nproc }}'
    - '* hard nproc {{ os_linux_ulimit_nproc }}'
